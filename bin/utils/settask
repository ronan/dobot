#!/bin/sh
set -e
[ -n "$DOBOT_TASK" ] || err "No task to add";

  pattern=$(echo "$DOBOT_TASK" | quotetask)
     task=$(readtasks | sed -rn "/$pattern$/,/- \[/ { /$pattern$/ { p; b }; /- \[/b; p; }")
   indent=$(echo "$task" | head -n 1 | sed -nr "s/^( *)- \[.?] .*$/\1/p")
   status=$(echo "$task" | head -n 1 | sed -nr "s/^ *- \[(.?)] .*$/\1/p")
 transput=$(echo "$task" | tail +2)
   parent=""
     find=$task

if [ -z "$task" ]; then
  debug "Adding '$DOBOT_TASK'"

  find="$"
  task="- [ ] $DOBOT_TASK"

  if [ -n "$DOBOT_PARENT" ]; then
    pattern=$(echo "$DOBOT_PARENT" | quotetask)
     indent=$(readtasks | sed -nr "s/^( *)- \[.?] $pattern$/\1/p")
    pattern="^$indent- \[.*] $(echo "$DOBOT_PARENT" | quotetask)$"
     parent=$(readtasks | sed -rn "/$pattern/,$ { /^$indent/p; /^$/p; b; }")

    [ -n "$parent" ] || err "Could not find parent $DOBOT_PARENT";

     indent="$indent  "
       find=$parent
  fi
fi

stdin=$(cat)
if [ -n "$stdin" ]; then
  status=${stdin%% *}
  transput=${stdin#?}
fi

replace="$parent\n$indent- [$status] $DOBOT_TASK"
if [ -n "$transput" ]; then
  replace="$replace\n$(echo "$transput" | sed "s/^ */$indent  /")"
fi

readtasks | sed -z "s/$(quotesed "$find")/$(quotesed "$replace")/" | writetasks

debug "## Set task

     Key: | Value    
--------: | :-----
    task: | '$task'
  indent: | '$indent'
  status: | '$status'
transput: | '$transput'
    find: | '$find'
 replace: | '$replace'
"