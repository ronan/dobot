#!/bin/sh
set -e
[ -n "$DOBOT_TASK" ] || err "No task to add";

stdin=$(cat)
if [ -n "$stdin" ]; then
  status=${stdin%% *}
  transput=${stdin#?}
fi

task=$(gettask)
if [ -n "$task" ]; then
  debug "Modifying '$DOBOT_TASK'"

     find=$task
   status=${status:-$(echo "$task" | taskstatus)}
   indent=$(echo "$task" | taskindent)
  replace="$indent- [${status:- }] $DOBOT_TASK"
 transput=${transput:-$(echo "$task" | tasktransput)}
else
  debug "Adding '$DOBOT_TASK'"

  # TODO: find a way to put new items with no parent at the end
  find="$"
  if [ -n "$DOBOT_PARENT" ]; then
      find=$(DOBOT_TASK="$DOBOT_PARENT" gettask -a)
    status=${status:- }
    indent="$(echo "$find" | taskindent)"
   replace="$find\n$indent  - [$status] $DOBOT_TASK"
  fi
fi

if [ -n "$transput" ]; then
  replace="$replace\n$(echo "$transput" | sed "s/^ */$indent  /")"
fi

readtasks | sed -z "s/$(quotesed "$find")/$(quotesed "$replace")/" | writetasks

debug "## Set task

     Key: | Value    
--------: | :-----
    task: | '$task'
  indent: | '$indent'
  status: | '$status'
transput: | '$transput'
    find: | '$find'
 replace: | '$replace'
"